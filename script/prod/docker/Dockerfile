# Frontend
FROM public.ecr.aws/bitnami/node:16.2.0-prod as frontend


RUN npm install -g npm@8.19.3
# RUN mkdir /app

ARG VUE_APP_STRIPE_KEY
ENV VUE_APP_STRIPE_KEY=$VUE_APP_STRIPE_KEY

ARG VUE_APP_API_URL
ENV VUE_APP_API_URL=$VUE_APP_API_URL

ARG VUE_APP_HCAPTCHA_SITE_KEY
ENV VUE_APP_HCAPTCHA_SITE_KEY=$VUE_APP_HCAPTCHA_SITE_KEY

ARG VUE_APP_HCAPTCHA_SECRET_KEY
ENV VUE_APP_HCAPTCHA_SECRET_KEY=$VUE_APP_HCAPTCHA_SECRET_KEY

ARG VUE_APP_TERMS_LINK
ENV VUE_APP_TERMS_LINK=$VUE_APP_TERMS_LINK

ARG VUE_APP_PRIVACY_LINK
ENV VUE_APP_PRIVACY_LINK=$VUE_APP_PRIVACY_LINK

ARG VUE_APP_GA_KEY
ENV VUE_APP_GA_KEY=$VUE_APP_GA_KEY

ARG VUE_APP_GOOGLE_PLAY_URL
ENV VUE_APP_GOOGLE_PLAY_URL=$VUE_APP_GOOGLE_PLAY_URL

ARG VUE_APP_APPLE_STORE_URL
ENV VUE_APP_APPLE_STORE_URL=$VUE_APP_APPLE_STORE_URL

ARG VUE_APP_AWS_RUM_ARN
ENV VUE_APP_AWS_RUM_ARN=$VUE_APP_AWS_RUM_ARN

ARG VUE_APP_AWS_RUM_POOL_ID
ENV VUE_APP_AWS_RUM_POOL_ID=$VUE_APP_AWS_RUM_POOL_ID

ARG VUE_APP_AWS_RUM_ENDPOINT
ENV VUE_APP_AWS_RUM_ENDPOINT=$VUE_APP_AWS_RUM_ENDPOINT

ARG VUE_APP_AWS_RUM_APPLICATION_ID
ENV VUE_APP_AWS_RUM_APPLICATION_ID=$VUE_APP_AWS_RUM_APPLICATION_ID

ARG VUE_APP_ENV
ENV VUE_APP_ENV=$VUE_APP_ENV

RUN touch /app/.env

RUN echo VUE_APP_STRIPE_KEY='"'$VUE_APP_STRIPE_KEY'"' >> /app/.env
RUN echo VUE_APP_API_URL='"'$VUE_APP_API_URL'"' >> /app/.env
RUN echo VUE_APP_HCAPTCHA_SITE_KEY='"'$VUE_APP_HCAPTCHA_SITE_KEY'"' >> /app/.env
RUN echo VUE_APP_HCAPTCHA_SECRET_KEY='"'$VUE_APP_HCAPTCHA_SECRET_KEY'"' >> /app/.env
RUN echo VUE_APP_TERMS_LINK='"'$VUE_APP_TERMS_LINK'"' >> /app/.env
RUN echo VUE_APP_PRIVACY_LINK='"'$VUE_APP_PRIVACY_LINK'"' >> /app/.env
RUN echo VUE_APP_GA_KEY='"'$VUE_APP_GA_KEY'"' >> /app/.env
RUN echo VUE_APP_APPLE_STORE_URL='"'$VUE_APP_APPLE_STORE_URL'"' >> /app/.env
RUN echo VUE_APP_GOOGLE_PLAY_URL='"'$VUE_APP_GOOGLE_PLAY_URL'"' >> /app/.env
RUN echo VUE_APP_AWS_RUM_ARN='"'$VUE_APP_AWS_RUM_ARN'"' >> /app/.env
RUN echo VUE_APP_AWS_RUM_POOL_ID='"'$VUE_APP_AWS_RUM_POOL_ID'"' >> /app/.env
RUN echo VUE_APP_AWS_RUM_ENDPOINT='"'$VUE_APP_AWS_RUM_ENDPOINT'"' >> /app/.env
RUN echo VUE_APP_AWS_RUM_APPLICATION_ID='"'$VUE_APP_AWS_RUM_APPLICATION_ID'"' >> /app/.env
RUN echo VUE_APP_ENV='"'$VUE_APP_ENV'"' >> /app/.env

WORKDIR /app
COPY package*.json ./
RUN npm install
COPY ./ .
RUN npm run build

# Nginx webserver
FROM public.ecr.aws/nginx/nginx:mainline-alpine-amd64

RUN mkdir /app
COPY --from=frontend /app/dist /app
COPY script/prod/nginx/nginx.conf /etc/nginx/nginx.conf
COPY script/prod/nginx/hw.conf /etc/nginx/conf.d/default.conf

EXPOSE 80
